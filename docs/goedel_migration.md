# Goedel Workbook Migration: Lean 4.8 → 4.27

## Overview

The [Goedel-LM/Lean-workbook-proofs](https://huggingface.co/datasets/Goedel-LM/Lean-workbook-proofs) dataset contains 29,750 competition-math proofs generated by DeepSeek-Prover-V1.5 against **Lean 4.8 / Mathlib ~v4.8**. Our project targets **Lean 4.27.0 / Mathlib v4.27.0** (via Pantograph). This document describes the migration process and automated fixes.

## Pipeline

All scripts live in `python/data/goedel_migration/`. Run from `vendor/Pantograph/` (where `lakefile.toml` and compiled Mathlib oleans live).

### Step 1: Extract proofs from HuggingFace

```bash
cd data/lean/goedel_migration
python3 extract_and_setup.py 0  # 0 = extract all 29,750
```

Creates `GoedelMigration/Proof_XXXXX.lean` files, symlinked into Pantograph root as `goedel_data/`.

### Step 2: Apply Mathlib rename fixes

```bash
cd vendor/Pantograph
python3 ../../python/data/goedel_migration/fix_renames.py --results compile_output/compilation_results.json
```

**Renames (v4.8 → v4.27):**

| Old name | New name | Occurrences |
|----------|----------|-------------|
| `le_div_iff` | `le_div_iff₀` | ~15/1000 |
| `div_le_div_iff` | `div_le_div_iff₀` | ~14/1000 |
| `div_le_iff` | `div_le_iff₀` | ~7/1000 |
| `add_left_neg` | `neg_add_cancel` | ~8/1000 |
| `add_right_neg` | `add_neg_cancel` | ~8/1000 |
| `true_and_iff` | `true_and` | ~1/1000 |
| `and_true_iff` | `and_true` | ~1/1000 |

**BigOperators notation change:**
- `∑ i in S, f` → `∑ i ∈ S, f`
- `∏ i in S, f` → `∏ i ∈ S, f`

Applied to ~18.4% of all files (5,462 / 29,750).

### Step 3: Compile (resumable batch)

```bash
python3 ../../python/data/goedel_migration/compile.py \
  --data-dir goedel_data --batch-size 1000 --workers 32 --timeout 60 \
  --out-dir compile_output
```

Features:
- Saves state to `compile_output/compile_state.json` after each batch
- `--resume` flag to continue from last completed batch
- Per-batch error logs: `compile_output/batch_NNNN_errors.log`
- Optimal concurrency: **32 workers** (128 cores available but >32 causes Lean timeout storms)

### Step 4: Fix rewrite failures (field_simp behavioral change)

```bash
python3 ../../python/data/goedel_migration/fix_rewrites.py --data-dir goedel_data
```

**Root cause:** `field_simp` in Mathlib v4.27 normalizes goals more aggressively than v4.8. After `field_simp`, the subsequent `rw [div_le_div_iff₀]` can't find the expected `?/? ≤ ?/?` pattern because one or both divisions were already cleared.

**Fix strategy:** Replace the rewrite with a `first` combinator that tries all division-clearing lemma variants, plus `skip` for when `field_simp` already handled everything:

```lean
-- Before (fails in v4.27):
rw [div_le_div_iff₀]

-- After (works in both):
(first | rw [div_le_div_iff₀] | rw [le_div_iff₀] | rw [div_le_iff₀] | skip) <;>
```

The `<;>` broadcasts the subsequent tactic to all goals (main + any positivity side goals). Leftover positivity-handling tactics from the original proof are wrapped in `try`.

**Coverage:** ~67% of all compilation errors are this pattern. Rescue rate: ~90% of affected files.

### Step 5: Re-run compilation on failures

After applying rewrite fixes, re-run the compiler with `--resume` to re-check previously failed files, or run a targeted recompile on just the error files.

## Error Categories (Batch 1, 1000 files)

| Category | Count | % of errors | Fixable? |
|----------|-------|-------------|----------|
| rewrite_div (field_simp change) | 132 | 66.7% | **Yes** (~90%) |
| timeout | 33 | 16.7% | Maybe (increase timeout) |
| linarith_failed | 6 | 3.0% | No (proof-level breakage) |
| max_recursion | 5 | 2.5% | No |
| field_simp_no_progress | 3 | 1.5% | No |
| simp_no_progress | 3 | 1.5% | No |
| no_goals | 3 | 1.5% | No |
| unsolved_goals | 2 | 1.0% | No |
| other | 11 | 5.6% | No |

## Expected Yield

Based on batch 1 (1000 files):

| Stage | Success rate | Cumulative |
|-------|-------------|------------|
| Pre-fix compilation | 79.1% (ok+warn) | 79.1% |
| After rename fixes | ~86% | 86% |
| After rewrite fixes | ~90% of remaining errors rescued | ~92-93% |

**Target:** ≥90% survival rate (≥26,775 of 29,750) — within Phase M target of ≥95%.

## Key Decisions

1. **`lake env lean` over direct `lean`:** `lake env lean` injects `LEAN_PATH` automatically from Pantograph's dependency graph. Direct `lean` with extracted `LEAN_PATH` was ~15% faster per file but caused more timeouts at 32 workers. The ~1s/file overhead is negligible.

2. **32 workers:** Tested 128, 64, 48, 32. Higher concurrency causes CPU contention and Lean timeout storms on this 128-core machine. 32 is the sweet spot.

3. **60s timeout:** Most proofs compile in 2-15s. A few complex ones take 30-50s. 60s catches nearly everything; the remaining timeouts are genuinely expensive proofs.

4. **Lean outputs errors to stdout:** Critical discovery — `result.stderr` is empty for Lean compilation errors. Must capture `result.stdout + result.stderr`.

## File Layout

```
python/data/goedel_migration/
├── __init__.py
├── compile.py       # Resumable batch compiler (32 workers, 60s timeout)
├── fix_renames.py   # Mathlib identifier renames + BigOperators syntax
└── fix_rewrites.py  # field_simp/rewrite combinator fix

vendor/Pantograph/
├── goedel_data/     # Symlink → data/lean/goedel_migration/GoedelMigration/
└── compile_output/  # Compilation results, state, per-batch error logs
```
